# SAS CI 360 – SAS Container Runtime Gateway

SAS Container Runtime (SCR) allows clients to deploy SAS Intelligent Decisioning flows as containers in Kubernetes or similar modern container architectures.  
The **CI 360 SCR Gateway** enables clients to integrate these SCR containers with SAS CI 360.

![ConnectorEndpoint](./docs/high-level.png)

## Key Objectives for Calling SAS ID Flows from SAS CI 360

- **Digital Behavior Decisioning**: Use data from SAS 360 to invoke SAS Intelligent Decisioning flows in real time.  
- **Contact Policy Verification**: Enforce contact policies before customer communication based on behavioral data.  
- **Rescoring NBO/NBA**: Update Next Best Offer (NBO) and Next Best Action (NBA) scores in real time.  
- **Customer Journey Personalization**: Retrieve personalized data to tailor customer interactions.  
- **Offer Validity Check**: Verify that offers are still valid before presenting them to customers.

By implementing this integration, organizations achieve more accurate and timely decision-making — improving customer experience and ensuring policy compliance.

## How It Works

![ConnectorEndpoint](./docs/flow.png)

The CI 360 SCR Gateway is a **Python FastAPI** application deployed alongside the SCR containers and a **SAS CI 360 General Agent**.  
The gateway exposes a private connector endpoint that SAS CI 360 can reach through the General Agent in a custom task.  
The General Agent maintains a WebSocket connection with the CI 360 tenant.

## Repository Contents

| File/folder                                      | Description                                           |
|--------------------------------------------------|-------------------------------------------------------|
| [gateway/](gateway/)                             | Docker recipe for SCR Gateway (FastAPI app)           |
| [agent/](agent/)                                 | Docker recipe for CI 360 General Agent (Java service) |
| [360.env](360.env)                               | SAS CI 360 General Agent configuration file           |
| [endpoints/](endpoints/)                         | One JSON file per SCR endpoint definition             |
| [docker-compose/](docker-compose/)               | Docker Compose scripts                                |
| [docker-compose.api.yml](docker-compose.api.yml) | Compose deployment without Postgres database          |
| [docker-compose.db.yml](docker-compose.db.yml)   | Compose deployment with Postgres database             |
| [k8s-sample/](k8s-sample/)                       | Kubernetes sample deployment                          |
| [testing/](testing/)                             | Test scripts for sending events                       |

## Defining SCR Endpoints

Each deployed SAS Container Runtime decision flow requires a JSON file defining `id`, `endpoint`, and `payload`:

```json
{
  "id": "<-- id used in connector definition -->",
  "endpoint": "<-- SCR endpoint URL -->",
  "payload": {
    <-- define SCR payload here -->
  }
}
```

Place this definition file in the [`endpoints/`](endpoints/) directory.

### Example

```json
{
  "id": "scr-redis",
  "endpoint": "https://host.docker.internal:8443/scr-redis",
  "payload": {
    "inputs": {
      "customer_id": "${event.properties.subject_id}",
      "some_number": 122,
      "some_text": "abc",
      "name": "${event.properties.name}",
      "text": "${event.outboundProperties.properties.greeting}",
      "dttm_raw": "${event.date.generatedTimestamp}",
      "dttm_str": "$str{event.date.generatedTimestamp}",
      "dttm_iso": "$timestamp{event.date.generatedTimestamp}",
      "call_id": "${record.call_id}"
    }
  }
}
```

### Notes

- The `id` is used by the CI 360 task (via the `scr_endpoint` outbound attribute) to identify the SCR endpoint.  
- The `endpoint` URL must be valid within the gateway container’s network context.  
- The `payload` defines the data sent to the SAS ID flow.

### SCR Payload Details

The `payload` section can include static or dynamic content.

**Dynamic content:**
- `${event.<path>}` – retrieves an attribute from the CI 360 event (incoming connector payload).  
- `${record.call_id}` – retrieves the unique request UUID generated by the gateway (used as the primary key if `USE_DB=true`).

**Transformations:**
- `$str{...}` – converts values to strings.  
  Example: `1751625227523 → "1751625227523"`  
- `$timestamp{...}` – converts an epoch millisecond timestamp to an ISO 8601 timestamp string.  
  Example: `1751625227523 → "2025-07-04T12:33:47.523"`  
  Invalid timestamps return `null`.

## Connecting from SAS CI 360

In SAS CI 360, use a **custom triggered task** with a **connector** to call the SCR Gateway.

### Connector Setup

1. Create a connector with a valid **access point**.  
2. Define a **POST** connector endpoint with URL:  
   ```
   http://gateway.local/scr
   ```
   ![ConnectorEndpoint](./docs/connector-endpoint.png)

### Custom Task Setup

The outbound data for the task must include the attribute `scr_endpoint`.  
Its value should match the `id` of the SCR endpoint JSON definition.

![Outbound Data](./docs/custom-task.png)

## Deploying with Docker Compose

1. Define a General Agent endpoint in CI 360 and configure the connector/custom task as described above.  
2. Enter CI 360 Agent properties into `360.env`.  
3. Run `docker-compose/startup.api.sh` to launch **without** Postgres logging.  
4. Or run `docker-compose/startup.db.sh` to launch **with** Postgres logging.  
5. Run `docker-compose/shutdown` to stop all containers.

## Deploying with Kubernetes

1. Start with a working Docker Compose deployment to validate configuration.  
2. Build and push the agent and gateway container images:  
   ```
   docker build ...
   docker push ...
   ```
3. Use [k8s-sample/](k8s-sample/) as a base for your Kubernetes deployment.  
   - If using Postgres (`USE_DB=true`) for request logging, configure a valid `DATABASE_URL` and create a `scr_gateway` schema in the target database.

### Gateway Environment Variables

| Variable       | Description                                           | Example Value                              |
|----------------|-------------------------------------------------------|--------------------------------------------|
| VERIFY_SSL     | Set to `false` for testing without SSL verification   | true                                       |
| CA_CERT_PATH   | Path to certificate file(s) for SCR endpoints         | /app/certs/server.crt                      |
| USE_DB         | Log requests to database                              | true                                       |
| DATABASE_URL   | Database connection string (if `USE_DB=true`)         | postgresql+asyncpg://scr:gateway@postgres/ |
